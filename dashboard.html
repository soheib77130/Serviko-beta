<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Serviko — Tableau de bord client</title>
  <meta name="description" content="Tableau de bord client Serviko." />
  <style>
    :root{
      --bg:#0b0f17;
      --card:#111827;
      --muted:#9ca3af;
      --text:#e5e7eb;
      --accent:#22c55e;
      --accent2:#60a5fa;
      --radius:18px;
      --shadow: 0 16px 40px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 20% 10%, rgba(96,165,250,.18), transparent 55%),
                  radial-gradient(900px 700px at 80% 0%, rgba(34,197,94,.16), transparent 55%),
                  var(--bg);
      color:var(--text);
      line-height:1.35;
    }
    a{color:inherit; text-decoration:none}
    .container{max-width:1100px; margin:0 auto; padding:24px}
    .nav{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800}
    .logo{
      width:36px; height:36px; border-radius:12px;
      background: linear-gradient(135deg, var(--accent2), var(--accent));
      display:grid; place-items:center; font-weight:900; color:#071018;
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 12px; border-radius:14px; font-weight:800; cursor:pointer;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color:var(--text);
    }
    .card{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(17,24,39,.55);
      border-radius: var(--radius);
      padding:18px;
      box-shadow: var(--shadow);
    }
    .cards2{display:grid; grid-template-columns: repeat(2, 1fr); gap:12px}
    @media (max-width: 900px){ .cards2{grid-template-columns:1fr} }
    .hint{color:var(--muted); font-weight:650}
    .list{margin:0; padding:0; list-style:none; display:grid; gap:8px}
    .pill{padding:6px 10px; border-radius:999px; background: rgba(96,165,250,.15); border:1px solid rgba(96,165,250,.22); font-weight:700; font-size:12px}
    .panel{display:grid; gap:12px}
  </style>
</head>
<body>
  <div class="container">
    <header class="nav">
      <a class="brand" href="index.html">
        <div class="logo">S</div>
        <div>Serviko</div>
      </a>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <a class="btn" href="index.html#client">Retour à l'espace client</a>
        <button class="btn" type="button" data-logout>Se déconnecter</button>
      </div>
    </header>

    <section class="panel">
      <div class="card">
        <h1>Tableau de bord client</h1>
        <p class="hint">Résumé de vos prestations et demandes en cours (exemple statique).</p>
      </div>

      <div class="cards2">
        <div class="card">
          <h3>Demandes actives</h3>
          <ul class="list" id="clientRequests">
            <li>Chargement des demandes...</li>
          </ul>
        </div>
        <div class="card">
          <h3>Actions rapides</h3>
          <div style="display:flex; gap:8px; flex-wrap:wrap">
            <span class="pill">Simulation de paiement</span>
            <span class="pill">Relancer un indépendant</span>
            <span class="pill">Télécharger une facture</span>
          </div>
          <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
            <a class="btn" href="request.html">Déposer une demande</a>
            <button class="btn" type="button" id="supportBtn">Contacter le support</button>
            <button class="btn" type="button" data-logout>Se déconnecter</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Messagerie & cahier des charges</h3>
        <p class="hint" id="conversationHint">Sélectionnez une demande pour discuter avec l'indépendant.</p>
        <div class="panel" style="grid-template-columns: 1.2fr 2fr; gap:16px">
          <div>
            <h4>Vos demandes</h4>
            <ul class="list" id="conversationList">
              <li>Chargement des demandes...</li>
            </ul>
          </div>
          <div class="card" style="background:rgba(17,24,39,.7)">
            <h4 id="conversationTitle">Discussion</h4>
            <div class="pill" id="conversationStatus">—</div>
            <div style="margin-top:12px">
              <h5>Cahier des charges</h5>
              <div class="list" id="specChecklist">Sélectionnez une demande.</div>
              <p class="hint">Paiement simulé : le prix est finalisé ici avant mise en production.</p>
              <div class="panel" style="margin-top:12px">
                <input type="number" id="negotiatedPrice" placeholder="Prix convenu (€)" min="0" />
                <button class="btn" type="button" id="saveSpecBtn">Mettre à jour</button>
                <button class="btn primary" type="button" id="confirmSpecBtn">Confirmer et passer au fil principal</button>
              </div>
            </div>
            <div style="margin-top:16px">
              <h5>Messages</h5>
              <div class="list" id="messageList">Aucun message.</div>
              <div style="margin-top:12px; display:flex; gap:8px">
                <input type="text" id="messageInput" placeholder="Écrire un message..." />
                <button class="btn primary" type="button" id="sendMessage">Envoyer</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://skfqoyyoahuaffshimnc.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_yxLCOU94zhGck9yvGYch5Q_ePCPd9Yq";
    const supportBtn = document.getElementById("supportBtn");
    const logoutButtons = Array.from(document.querySelectorAll("[data-logout]"));
    const header = document.querySelector("h1");
    const clientRequests = document.getElementById("clientRequests");
    const conversationList = document.getElementById("conversationList");
    const conversationTitle = document.getElementById("conversationTitle");
    const conversationStatus = document.getElementById("conversationStatus");
    const conversationHint = document.getElementById("conversationHint");
    const specChecklist = document.getElementById("specChecklist");
    const negotiatedPrice = document.getElementById("negotiatedPrice");
    const saveSpecBtn = document.getElementById("saveSpecBtn");
    const confirmSpecBtn = document.getElementById("confirmSpecBtn");
    const messageList = document.getElementById("messageList");
    const messageInput = document.getElementById("messageInput");
    const sendMessage = document.getElementById("sendMessage");
    let currentRequest = null;
    const supabaseClient = window.supabase?.createClient?.(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        storage: window.localStorage
      }
    });

    async function hydrateProfile(){
      if (!supabaseClient) return;
      const { data: { session } } = await supabaseClient.auth.getSession();
      const user = session?.user;
      if (!user){
        window.location.href = "login.html";
        return;
      }
      if (user.user_metadata?.role && user.user_metadata.role !== "client"){
        await supabaseClient.auth.signOut();
        window.location.href = "login.html";
        return;
      }
      const { data } = await supabaseClient
        .from("clients")
        .select("firstname, lastname")
        .eq("user_id", user.id)
        .maybeSingle();
      const name = [data?.firstname, data?.lastname].filter(Boolean).join(" ");
      if (header){
        header.textContent = name ? `Tableau de bord de ${name}` : "Tableau de bord client";
      }
      if (clientRequests){
        const { data: requests, error } = await supabaseClient
          .from("requests")
          .select("id, title, status, created_at, match_summary, negotiated_price")
          .eq("client_user_id", user.id)
          .order("created_at", { ascending: false })
          .limit(5);
        if (error){
          clientRequests.innerHTML = "<li>Impossible de charger les demandes.</li>";
          return;
        }
        if (!requests || requests.length === 0){
          clientRequests.innerHTML = "<li>Aucune demande en cours.</li>";
          return;
        }
        clientRequests.innerHTML = requests.map((item) => (
          `<li><strong>${item.title}</strong> — ${item.status || "nouveau"}</li>`
        )).join(\"\\n\");
        if (conversationList){
          conversationList.innerHTML = requests.map((item) => (
            `<li><button class="btn" data-request="${item.id}">${item.title}</button><div class="hint">${item.match_summary || item.status}</div></li>`
          )).join(\"\\n\");
          conversationList.querySelectorAll("button[data-request]").forEach((btn) => {
            btn.addEventListener("click", () => {
              const requestId = Number(btn.dataset.request);
              loadConversation(requestId, user.id);
            });
          });
        }
      }
    }

    hydrateProfile();

    if (supportBtn){
      supportBtn.addEventListener("click", () => {
        alert("Support contacté (démo). Nous revenons vers vous rapidement.");
      });
    }

    if (logoutButtons.length){
      logoutButtons.forEach((button) => {
        button.addEventListener("click", async () => {
          if (supabaseClient){
            await supabaseClient.auth.signOut();
          }
          alert("Vous êtes déconnecté.");
          window.location.href = "index.html";
        });
      });
    }

    async function loadConversation(requestId, userId){
      if (!supabaseClient) return;
      const { data: request } = await supabaseClient
        .from("requests")
        .select("id, title, status, spec_checklist, negotiated_price")
        .eq("id", requestId)
        .eq("client_user_id", userId)
        .maybeSingle();
      if (!request) return;
      currentRequest = request;
      if (conversationTitle) conversationTitle.textContent = request.title || "Discussion";
      if (conversationStatus) conversationStatus.textContent = request.status || "nouveau";
      if (conversationHint) conversationHint.textContent = request.status === "negociation"
        ? "Messagerie instantanée pour cadrer le prix et le cahier des charges."
        : "Fil principal après validation du cahier des charges.";
      renderChecklist(request.spec_checklist || []);
      if (negotiatedPrice) negotiatedPrice.value = request.negotiated_price || "";
      await loadMessages(request.id, request.status);
    }

    function renderChecklist(items){
      if (!specChecklist) return;
      if (!items || items.length === 0){
        specChecklist.textContent = "Aucun cahier des charges enregistré.";
        return;
      }
      specChecklist.innerHTML = items.map((item, index) => (
        `<label style="display:flex; gap:8px; align-items:center;">
          <input type="checkbox" data-index="${index}" ${item.checked ? "checked" : ""}/>
          ${item.label}
        </label>`
      )).join("");
    }

    async function loadMessages(requestId, status){
      if (!messageList) return;
      const channel = status === "confirme" ? "fil" : "instant";
      const { data: messages, error } = await supabaseClient
        .from("request_messages")
        .select("sender_role, body, created_at")
        .eq("request_id", requestId)
        .eq("channel", channel)
        .order("created_at", { ascending: true });
      if (error){
        messageList.innerHTML = "<div class='hint'>Impossible de charger les messages.</div>";
        return;
      }
      if (!messages || messages.length === 0){
        messageList.innerHTML = "<div class='hint'>Aucun message pour le moment.</div>";
        return;
      }
      messageList.innerHTML = messages.map((msg) => (
        `<div><strong>${msg.sender_role}</strong> — ${msg.body}</div>`
      )).join("");
    }

    if (saveSpecBtn){
      saveSpecBtn.addEventListener("click", async () => {
        if (!currentRequest || !supabaseClient) return;
        const checklist = Array.from(specChecklist?.querySelectorAll("input[type='checkbox']") || [])
          .map((checkbox) => ({
            label: checkbox.parentElement?.textContent?.trim() || "",
            checked: checkbox.checked
          }));
        const price = negotiatedPrice?.value ? Number(negotiatedPrice.value) : null;
        await supabaseClient
          .from("requests")
          .update({ spec_checklist: checklist, negotiated_price: price })
          .eq("id", currentRequest.id);
        alert("Cahier des charges mis à jour.");
      });
    }

    if (confirmSpecBtn){
      confirmSpecBtn.addEventListener("click", async () => {
        if (!currentRequest || !supabaseClient) return;
        await supabaseClient
          .from("requests")
          .update({ status: "confirme" })
          .eq("id", currentRequest.id);
        currentRequest.status = "confirme";
        if (conversationStatus) conversationStatus.textContent = "confirme";
        await loadMessages(currentRequest.id, currentRequest.status);
        alert("Cahier des charges confirmé. La conversation passe au fil principal.");
      });
    }

    if (sendMessage){
      sendMessage.addEventListener("click", async () => {
        if (!currentRequest || !supabaseClient || !messageInput?.value) return;
        const channel = currentRequest.status === "confirme" ? "fil" : "instant";
        const { data: { session } } = await supabaseClient.auth.getSession();
        const user = session?.user;
        if (!user) return;
        const { error } = await supabaseClient
          .from("request_messages")
          .insert({
            request_id: currentRequest.id,
            sender_user_id: user.id,
            sender_role: "client",
            channel,
            body: messageInput.value.trim()
          });
        if (!error){
          messageInput.value = "";
          await loadMessages(currentRequest.id, currentRequest.status);
        }
      });
    }
  </script>
</body>
</html>
